<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Order Success - Cold Container</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Pacifico&display=swap');
    body{font-family:'Poppins',sans-serif;background:#f5f5f5}
    .box{max-width:700px;margin:3rem auto;padding:2rem;background:#fff;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  </style>
</head>
<body>
  <div class="container">
    <div class="box text-center">
      <h2 class="mb-3">Thank you for your order!</h2>
      <p class="lead">Your payment was processed (mock) and we received your order.</p>
      <p>Order ID: <strong><%= orderId %></strong></p>
      <p>Total: <strong>$<%= total %></strong></p>
      <div class="d-flex justify-content-center gap-2 mt-3">
        <a href="/" class="btn btn-success">Continue shopping</a>
        <a href="/invoice/<%= orderId %>" class="btn btn-outline-success">Get e-receipt here</a>
        <% if (typeof user !== 'undefined' && user) { %>
          <a href="/order-history" class="btn btn-outline-primary">View Order History</a>
        <% } else { %>
          <% if (typeof email !== 'undefined' && email) { %>
            <a href="/order-history?email=<%= encodeURIComponent(email) %>" class="btn btn-outline-primary">View Order History</a>
          <% } %>
        <% } %>
      </div>
      <!-- Feedback form for customers after purchase -->
      <div class="mt-4 text-start">
        <h5>Tell us about your experience</h5>
        <p class="text-muted">We'd love to hear your feedback about the website or checkout process.</p>
        <form id="postFeedbackForm">
          <div class="mb-2">
            <label for="fbName" class="form-label">Name (optional)</label>
            <input type="text" id="fbName" name="name" class="form-control" placeholder="Your name" value="<%= (user && user.username) ? user.username : '' %>">
          </div>
          <div class="mb-2">
            <label for="fbEmail" class="form-label">Email (optional)</label>
            <input type="email" id="fbEmail" name="email" class="form-control" placeholder="Your email" value="<%= typeof email !== 'undefined' && email ? email : (user && user.username ? user.username : '') %>">
          </div>
          <div class="mb-2">
            <label for="fbMessage" class="form-label">Message</label>
            <textarea id="fbMessage" name="message" class="form-control" rows="4" required placeholder="What did you like? What can we improve?"></textarea>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button type="submit" class="btn btn-primary">Send feedback</button>
            <div id="fbStatus" class="text-success" style="display:none">Thanks â€” feedback saved.</div>
            <div id="fbError" class="text-danger" style="display:none">Could not save feedback. Try again.</div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <%- include('partials/cartButton') %>
  <script>
    (function(){
      const form = document.getElementById('postFeedbackForm');
      if (!form) return;
      const statusEl = document.getElementById('fbStatus');
      const errorEl = document.getElementById('fbError');

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        if (statusEl) statusEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';

        const data = {
          name: document.getElementById('fbName') ? document.getElementById('fbName').value : '',
          email: document.getElementById('fbEmail') ? document.getElementById('fbEmail').value : '',
          message: document.getElementById('fbMessage') ? document.getElementById('fbMessage').value : ''
        };

        if (!data.message || data.message.trim().length === 0) {
          if (errorEl) { errorEl.textContent = 'Please enter a message'; errorEl.style.display = 'block'; }
          return;
        }

        try {
          const resp = await fetch('/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: data.email, message: data.message })
          });
          if (!resp.ok) {
            const txt = await resp.text().catch(()=>null);
            if (errorEl) { errorEl.textContent = txt || 'Could not save feedback'; errorEl.style.display = 'block'; }
            return;
          }
          if (statusEl) { statusEl.style.display = 'block'; }
          // clear message field
          if (document.getElementById('fbMessage')) document.getElementById('fbMessage').value = '';
        } catch (err) {
          if (errorEl) { errorEl.textContent = 'Network error'; errorEl.style.display = 'block'; }
        }
      });
    })();
  </script>
</body>
</html>