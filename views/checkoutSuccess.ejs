<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Order Success - Cold Container</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Pacifico&display=swap');
    body { font-family: 'Poppins', sans-serif; background: #f5f5f5; }
    .box { max-width: 700px; margin: 3rem auto; padding: 2rem; background: #fff; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    .status-badge { font-size: 0.95rem; }
    .rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-start; gap: 0.25rem; }
    .rating-input input { display: none; }
    .rating-input label { font-size: 1.6rem; color: #d9d9d9; cursor: pointer; margin: 0; }
    .rating-input input:checked ~ label,
    .rating-input label:hover,
    .rating-input label:hover ~ label { color: #f4c150; }
  </style>
</head>
<body>
  <div class="container">
    <div class="box text-center">
      <h2 class="mb-3">Thank you for your order!</h2>
      <p class="lead">We received your order and will keep the payment status updated in real time.</p>
      <p>Order ID: <strong><%= orderId %></strong></p>
      <p>Total: <strong>$<%= total %></strong></p>

      <div id="paymentStatusAlert" class="alert alert-secondary" role="alert">
        Payment status:
        <span id="paymentStatusBadge" class="badge text-bg-secondary status-badge ms-2">Pending</span>
      </div>

      <div class="d-flex justify-content-center gap-2 mt-3 flex-wrap">
        <a href="/" class="btn btn-success">Continue shopping</a>
        <a href="/invoice/<%= orderId %>" class="btn btn-outline-success">Get e-receipt here</a>
        <% if (typeof user !== 'undefined' && user) { %>
          <a href="/order-history" class="btn btn-outline-primary">View Order History</a>
        <% } else if (typeof email !== 'undefined' && email) { %>
          <a href="/order-history?email=<%= encodeURIComponent(email) %>" class="btn btn-outline-primary">View Order History</a>
        <% } %>
      </div>

      <!-- Feedback form for customers after purchase -->
      <div class="mt-4 text-start">
        <h5>Tell us about your experience</h5>
        <p class="text-muted">We'd love to hear your feedback about the website or checkout process.</p>
        <form id="postFeedbackForm">
          <div class="mb-2">
            <label class="form-label">Star Rating</label>
            <div class="rating-input" aria-label="Rate your experience">
              <input type="radio" id="fbStar5" name="rating" value="5">
              <label for="fbStar5" title="5 stars"><i class="fas fa-star"></i></label>
              <input type="radio" id="fbStar4" name="rating" value="4">
              <label for="fbStar4" title="4 stars"><i class="fas fa-star"></i></label>
              <input type="radio" id="fbStar3" name="rating" value="3">
              <label for="fbStar3" title="3 stars"><i class="fas fa-star"></i></label>
              <input type="radio" id="fbStar2" name="rating" value="2">
              <label for="fbStar2" title="2 stars"><i class="fas fa-star"></i></label>
              <input type="radio" id="fbStar1" name="rating" value="1">
              <label for="fbStar1" title="1 star"><i class="fas fa-star"></i></label>
            </div>
            <div class="text-muted small">Optional</div>
          </div>
          <div class="mb-2">
            <label for="fbName" class="form-label">Name (optional)</label>
            <input type="text" id="fbName" name="name" class="form-control" placeholder="Your name" value="<%= (user && user.username) ? user.username : '' %>">
          </div>
          <div class="mb-2">
            <label for="fbEmail" class="form-label">Email (optional)</label>
            <input type="email" id="fbEmail" name="email" class="form-control" placeholder="Your email" value="<%= typeof email !== 'undefined' && email ? email : (user && user.username ? user.username : '') %>">
          </div>
          <div class="mb-2">
            <label for="fbMessage" class="form-label">Message</label>
            <textarea id="fbMessage" name="message" class="form-control" rows="4" required placeholder="What did you like? What can we improve?"></textarea>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button type="submit" class="btn btn-primary">Send feedback</button>
            <div id="fbStatus" class="text-success" style="display:none">Thanks - feedback saved.</div>
            <div id="fbError" class="text-danger" style="display:none">Could not save feedback. Try again.</div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <%- include('partials/cartButton') %>
  <script>
    (function () {
      const orderId = <%- JSON.stringify(orderId) %>;
      const initialStatus = <%- JSON.stringify(paymentStatus || 'pending') %>;
      const badge = document.getElementById('paymentStatusBadge');
      const alertBox = document.getElementById('paymentStatusAlert');
      let source = null;

      function presentation(status) {
        const value = String(status || 'pending').toLowerCase();
        if (value === 'successful') return { label: 'Successful', cls: 'text-bg-success', alert: 'alert-success' };
        if (value === 'failed') return { label: 'Failed', cls: 'text-bg-danger', alert: 'alert-danger' };
        if (value === 'refunded') return { label: 'Refunding', cls: 'text-bg-info', alert: 'alert-info' };
        return { label: 'Pending', cls: 'text-bg-warning', alert: 'alert-warning' };
      }

      function setStatus(status) {
        if (!badge || !alertBox) return;
        const p = presentation(status);
        badge.textContent = p.label;
        badge.className = `badge status-badge ms-2 ${p.cls}`;
        alertBox.className = `alert mt-3 ${p.alert}`;
      }

      setStatus(initialStatus);

      if (orderId) {
        source = new EventSource(`/sse/order-status/${encodeURIComponent(orderId)}`);
        source.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'heartbeat') return;
            setStatus(data.status);
          } catch (err) {
            console.error('Failed to parse payment status update:', err);
          }
        };
        source.onerror = () => {
          console.warn('Payment status stream disconnected.');
        };
      }

      window.addEventListener('beforeunload', () => {
        if (source) source.close();
      });
    })();

    (function(){
      const form = document.getElementById('postFeedbackForm');
      if (!form) return;
      const statusEl = document.getElementById('fbStatus');
      const errorEl = document.getElementById('fbError');

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        if (statusEl) statusEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';

        const data = {
          name: document.getElementById('fbName') ? document.getElementById('fbName').value : '',
          email: document.getElementById('fbEmail') ? document.getElementById('fbEmail').value : '',
          message: document.getElementById('fbMessage') ? document.getElementById('fbMessage').value : '',
          rating: (document.querySelector('input[name="rating"]:checked') || {}).value || null
        };

        if (!data.message || data.message.trim().length === 0) {
          if (errorEl) { errorEl.textContent = 'Please enter a message'; errorEl.style.display = 'block'; }
          return;
        }

        try {
          const resp = await fetch('/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: data.email, message: data.message, rating: data.rating })
          });
          if (!resp.ok) {
            const txt = await resp.text().catch(()=>null);
            if (errorEl) { errorEl.textContent = txt || 'Could not save feedback'; errorEl.style.display = 'block'; }
            return;
          }
          if (statusEl) { statusEl.style.display = 'block'; }
          if (document.getElementById('fbMessage')) document.getElementById('fbMessage').value = '';
        } catch (err) {
          if (errorEl) { errorEl.textContent = 'Network error'; errorEl.style.display = 'block'; }
        }
      });
    })();
  </script>
</body>
</html>
